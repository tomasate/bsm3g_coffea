datasets:
  mc:
    - dy_inclusive
    - dy_ht
    - singletop
    - tt
    - wjets_ht
    - wjets_inclusive
    - diboson
    - higgs
object_selection:
  muons:
    field: events.Muon
    add_field: 
      transverse_mass: np.sqrt(2.0 * events.Muon.pt * events.MET.pt * (ak.ones_like(events.MET.pt) - np.cos(events.Muon.delta_phi(events.MET))))
    cuts:
      - events.Muon.pt > 30
      - np.abs(events.Muon.eta) < 2.1
      - working_points.muons_id(events, 'tight')
      - working_points.muons_iso(events, 'tight')
      - (objects['muons'].transverse_mass > 60) & (objects['muons'].transverse_mass < 100)
  veto_muons:
    field: events.Muon
    cuts:
      - events.Muon.pt > 3
      - events.Muon.pt < 30
      - np.abs(events.Muon.eta) < 2.1
      - working_points.muons_id(events, 'tight')
      - working_points.muons_iso(events, 'tight')
  electrons:
    field: events.Electron
    cuts:
      - events.Electron.pt > 5
      - np.abs(events.Electron.eta) < 2.1
      - working_points.electrons_id(events, 'wp90iso')
      - delta_r_mask(events.Electron, objects['muons'], 0.4)
  taus:
    field: events.Tau
    cuts:
      - events.Tau.pt > 20
      - np.abs(events.Tau.eta) < 2.3
      - np.abs(events.Tau.dz) < 0.2
      - working_points.taus_vs_jet(events, 'loose')
      - working_points.taus_vs_ele(events, 'vvloose')
      - working_points.taus_vs_mu(events, 'loose')
      - working_points.taus_decaymode(events, '13')
      - delta_r_mask(events.Tau, objects['electrons'], 0.3)
      - delta_r_mask(events.Tau, objects['muons'], 0.3)
  bjets:
    field: events.Jet
    cuts:
      - events.Jet.pt > 30
      - np.abs(events.Jet.eta) < 2.4
      - working_points.jets_id(events, year, 'tightlepveto')
      - delta_r_mask(events.Jet, objects['electrons'], 0.4)
      - delta_r_mask(events.Jet, objects['muons'], 0.4)
      - delta_r_mask(events.Jet, objects['taus'], 0.4)
  met:
    field: select_ztojets_met
  dimuons:
    field: select_dimuons
    cuts:
      - (objects['dimuons'].p4.mass > 60) & (objects['dimuons'].p4.mass < 120)
      - objects['dimuons'].l1.charge * objects['dimuons'].l2.charge < 0
  dijets:
    field: select_dijets
    cuts:
      - np.abs(objects['dijets'].j1.eta - objects['dijets'].j2.eta) > 3.8
      - objects['dijets'].j1.eta * objects['dijets'].j2.eta < 0
      - objects['dijets'].p4.mass > 500
  max_dijet_mass:
    field: select_max_mass_dijet
  max_dijets_mass_eta:
    field: select_max_mass_dijet_eta
event_selection:
  hlt_paths:
    muon:
      - SingleMu
  selections:
    goodvertex: events.PV.npvsGood > 0
    lumi: get_lumi_mask(events, year)
    trigger: get_trigger_mask(events, hlt_paths, dataset, year)
    trigger_match: get_trigger_match_mask(events, hlt_paths, year, events.Muon)
    metfilters: get_metfilters_mask(events, year)
    hemcleaning: get_hemcleaning_mask(events, year)
    dy_stitching: get_stitching_mask(events, dataset, 'DYJetsToLL_inclusive', 70)
    w_stitching: get_stitching_mask(events, dataset, 'WJetsToLNu_inclusive', 100)
    met_250: objects['met'].pt > 250
    one_muon: ak.num(objects['muons']) == 1
    muon_veto: ak.num(objects['veto_muons']) == 0
    electron_veto: ak.num(objects['electrons']) == 0
    tau_veto: ak.num(objects['taus']) == 0
    bjet_veto: ak.num(objects['bjets']) == 0
    atleast_one_jet: ak.num(objects['jets']) > 0
    atleast_two_jets: ak.num(objects['jets']) > 1
    atleast_one_dijet: ak.num(objects['dijets']) > 0
  categories:
    central:
      - goodvertex
      - lumi
      - trigger
      - trigger_match
      - metfilters
      - dy_stitching
      - w_stitching
      - met_250
      - hemcleaning
      - one_muon
      - muon_veto
      - electron_veto
      - tau_veto
      - bjet_veto
    vbf:
      - goodvertex
      - lumi
      - trigger
      - trigger_match
      - metfilters
      - dy_stitching
      - w_stitching
      - met_250
      - hemcleaning
      - one_muon
      - muon_veto
      - electron_veto
      - tau_veto
      - bjet_veto
      - atleast_two_jets
      - atleast_one_dijet
corrections:
  objects:
    - jets
    - muons
    - taus
    - met
    - jets_veto
  apply_obj_syst: false
  event_weights:
    genWeight: true
    pileupWeight: true
    l1prefiring: true
    lhepdfWeight: false
    lhescaleWeight: false
    partonshowerWeight: true
    pujetid:
      - id: tight
    btagging:
      - id: medium
      - full_run: false
      - bc: true
      - light: true
    electron: false
    muon:
      - id: tight
      - iso: tight
      - reco: true
      - trigger: true
    tau: false
histogram_config:
  flow: true
  add_weight: false
  add_syst_axis: false
  axes:
    jet_pt:
      type: Variable
      edges:
        - 20
        - 30
        - 50
        - 70
        - 100
        - 140
        - 200
        - 300
        - 600
        - 1000
      label: Jet $p_T$ [GeV]
      expression: objects['jets'].pt
    jet_abseta:
      type: Variable
      edges: 
        - 0
        - 1.3
        - 2.5
      label: Jet $|\eta|$
      expression: np.abs(objects['jets'].eta)
    jet_flavor:
      type: IntCategory
      categories: [0, 4, 5]
      label: Jet hadronFlavour
      expression: objects['jets'].hadronFlavour
    jet_pass_loose_wp:
      type: Boolean
      label: pass loose WP
      expression: objects['jets'].pass_loose_wp
    jet_pass_medium_wp:
      type: Boolean
      label: pass medium WP
      expression: objects['jets'].pass_medium_wp
    jet_pass_tight_wp:
      type: Boolean
      label: pass tight WP
      expression: objects['jets'].pass_tight_wp
  layout:
    eff_loose:
      - jet_pt
      - jet_abseta
      - jet_flavor
      - jet_pass_loose_wp
    eff_medium:
      - jet_pt
      - jet_abseta
      - jet_flavor
      - jet_pass_medium_wp
    eff_tight:
      - jet_pt
      - jet_abseta
      - jet_flavor
      - jet_pass_tight_wp